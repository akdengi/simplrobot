<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8" />
	<title>–†–µ–¥–∞–∫—Ç–æ—Ä –£—Ä–æ–≤–Ω–µ–π</title>
<style>
:root {
  /* –¶–≤–µ—Ç–∞ */
  --bg-main: #f8f9fa;
  --text-color: #212529;
  --border-color: #ced4da;
  --btn-bg: #fff;
  --accent: #4a90e2;
  --danger: #ff4d4f;
  --secondary: #6c757d;

  /* –¶–≤–µ—Ç–∞ —Å–ª–æ—ë–≤ */
  --layer-0: LimeGreen;  
  --layer-1: MediumOrchid;
  --layer-2: CornflowerBlue;
  --layer-3: Chocolate;

  /* –¢–æ–∫–µ–Ω—ã */
  --token-border: #999;

  /* –†–∞–∑–º–µ—Ä—ã */
  --radius: 8px;
  --gap: 1rem;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg-main);
  margin: 0;
  padding: 20px;
  color: var(--text-color);
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  flex-wrap: wrap;
  gap: var(--gap);
  justify-content: center;
}

/* === –ö–∞—Ä—Ç–æ—á–∫–∏ === */
.card {
  background: white;
  border-radius: var(--radius);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: var(--gap);
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.card h3,
.card h4 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.controls-section {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.layers-control,
.field-settings {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  align-items: center;
  text-align: center;
}

.layer-buttons {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  flex-wrap: wrap;
  border-width: 2px; /* –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –≥—Ä–∞–Ω–∏—Ü—ã */
}

.layer-button.active {
  font-weight: bold;
  /* –ù–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å border-width */
}

/* === –ö–Ω–æ–ø–∫–∏ —Å–ª–æ–µ–≤ === */
.layer-button {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  cursor: pointer;
  background: var(--btn-bg);
  transition: all 0.2s ease;
  flex: 1 1 auto;
  min-width: 80px;
  text-align: center;
}

.layer-button.active {
  font-weight: bold;
  outline: 2px solid black;
}

.layer-button[data-layer="0"].active { background-color: var(--layer-0); color: white; }
.layer-button[data-layer="1"].active { background-color: var(--layer-1); color: white; }
.layer-button[data-layer="2"].active { background-color: var(--layer-2); color: white; }
.layer-button[data-layer="3"].active { background-color: var(--layer-3); color: white; }

/* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Ç–æ–∫–µ–Ω–∞ —Å —Ñ–æ–Ω–æ–º */
.token-wrapper {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.layer-button:hover:not(.active) {
  background-color: #f0f0f0;
}

/* === –§–æ—Ä–º—ã === */
input[type="text"],
textarea {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  resize: vertical;
  transition: border 0.2s ease;
  box-sizing: border-box;
}

input:focus,
textarea:focus {
  border-color: var(--accent);
  outline: none;
}

/* === –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π === */
.action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: var(--gap);
  justify-content: center;
  margin-top: calc(var(--gap) * 2);
}

.action-buttons button i.material-icons {
  font-size: 18px;
  vertical-align: middle;
  margin-right: 6px;
}

.btn {
  padding: 0.75rem 1.25rem;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.btn.primary {
  background-color: var(--accent);
  color: white;
}

.btn.danger {
  background-color: var(--danger);
  color: white;
}

.btn.secondary {
  background-color: var(--secondary);
  color: white;
}

.btn.tertiary {
  background-color: #e9ecef;
  color: var(--text-color);
}

.btn:hover {
  opacity: 0.9;
}

/* === –¢–æ–∫–µ–Ω—ã === */
.tokens-panel {
  min-height: 150px;
}

.token-item {
  display: inline-block;
  margin: 5px;
  cursor: grab;
  user-select: none;
  text-align: center;
  pointer-events: auto;
}

.token-item img {
  width: 60px;
  height: 60px;
  object-fit: contain;
  border: 2px solid var(--token-border);
  border-radius: 3px;
  padding: 2px;
}

.counter {
  font-size: 12px;
  color: gray;
  margin-top: -5px;
  text-align: center;
}

/* === –°–µ—Ç–∫–∞ === */
.main-grid-container {
  position: relative;
  width: 900px;
  aspect-ratio: 1 / 1;
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  gap: 1px;
  background-color: transparent;
}

.grid-cell {
  width: 100%;
  height: 100%;
  background-color: transparent;
  box-sizing: border-box;
  position: relative;
  border: 1px solid var(--border-color);
}

.grid-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: contents;
}

.grid-field {
  position: absolute;
  cursor: move;
  user-select: none;
  width: 100%;
  height: 100%;
  pointer-events: auto;
  object-fit: contain;
  border: 2px solid black;
}

.token {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 80%;
  max-height: 80%;
  pointer-events: auto;
  cursor: default !important;
  user-select: none;
}

.token-title {
  font-size: 12px;
  color: var(--text-color);
  text-align: center;
  margin-top: -3px;
}

/**.token.layer-1 { outline: 2px solid var(--layer-1); }
.token.layer-2 { outline: 2px solid var(--layer-2); }
.token.layer-3 { outline: 2px solid var(--layer-3); } **/

/* === –¶–≤–µ—Ç–Ω—ã–µ —Ñ–æ–Ω—ã –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–æ —Å–ª–æ—è–º === */
/* –¶–≤–µ—Ç–Ω—ã–µ —Ñ–æ–Ω—ã –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ —Å–ª–æ—è–º */
.token-bg-layer-0 { background-color: color-mix(in srgb, var(--layer-0), transparent 30%); }
.token-bg-layer-1 { background-color: color-mix(in srgb, var(--layer-1), transparent 30%); }
.token-bg-layer-2 { background-color: color-mix(in srgb, var(--layer-2), transparent 30%); }
.token-bg-layer-3 { background-color: color-mix(in srgb, var(--layer-3), transparent 30%); }

.selected {
  outline: 4px solid #ff0000 !important;
}

.level-info {
  margin-top: var(--gap);
}

.level-info-inner {
  max-width: 900px; /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å .main-grid-container */
  width: 100%;
  margin: 0 auto;
  padding: 0 1rem;
  box-sizing: border-box;
}

.level-info-inner input[type="text"],
.level-info-inner textarea {
  width: 100%;
  font-size: 1rem;
  padding: 0.75rem;
  box-sizing: border-box;
}

/* === –ó–æ–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã === */
.trash-zone {
  width: 15%;
  min-width: 180px;
  height: 900px; /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å .main-grid-container */
  background-color: #fff;
  border: 2px dashed var(--danger);
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  transition: background-color 0.3s ease;
}

.trash-icon {
  text-align: center;
  color: var(--danger);
}

.trash-icon i.material-icons {
  font-size: 48px;
  display: block;
}

.trash-icon span {
  font-size: 14px;
  margin-top: 10px;
  display: block;
  padding: 0 10px;
}

/* === –ü–µ—á–∞—Ç—å === */
@media print, screen and (-webkit-min-device-pixel-ratio: 0), not all and (min-resolution: .001dpcm) {
  .grid-cell::before {
    background-color: transparent !important;
  }
}

.print-mode .grid-cell {
  border: none !important;
}

.print-mode .token {
  outline: none !important;
}

.grid-cell::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ddd;
  z-index: -1;
}

.layers-and-fields {
  display: flex;
  justify-content: space-between;
  gap: var(--gap);
}

.layers-control,
.field-settings {
  flex: 1;
  min-width: 250px;
}

.fields-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  justify-content: center;
}

/* === –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–Ω—ã—Ö –∂–µ—Ç–æ–Ω–æ–≤ –Ω–∞ –ø–∞–Ω–µ–ª–∏ === */
.token-pair-wrapper {
  display: inline-block;
  margin: 2px;
}

.pair-overlay {
  display: flex;
  align-items: center;
  gap: 2px;
  background-color: #e9ecef; /* –°–µ—Ä—ã–π —Ñ–æ–Ω */
  border-radius: var(--radius);
  padding: 4px 8px;
  margin: 2px;
}

/* === –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ === */
@media (max-width: 768px) {
  html {
    font-size: 80%; /* –£–º–µ–Ω—å—à–∞–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
  }

  .main-grid-container {
    width: 95vw;
  }

  .container {
    flex-direction: column;
    align-items: stretch;
  }

  .controls-section {
    flex-direction: column;
  }

  .layer-buttons {
    flex-wrap: wrap;
  }

  input[type="text"],
  textarea {
    font-size: 0.85rem;
    padding: 0.5rem;
  }

  .card h3,
  .card h4 {
    font-size: 0.9rem;
  }

  .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
  }

  .layers-and-fields {
    flex-direction: column;
  }

  .layers-control,
  .field-settings {
    width: 100%;
  }

  /* –£–º–µ–Ω—å—à–∞–µ–º –∫–Ω–æ–ø–∫–∏ –°–õ–û–ô */
  .layer-button {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
  }

  /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–æ–∫–µ–Ω–æ–≤ –≤ 2 —Ä–∞–∑–∞ */
  .token-item img {
    width: 30px;
    height: 30px;
    padding: 1px;
    border-width: 0.5px;
  }

  .counter {
    font-size: 8px;
    margin-top: -3px;
  }

  .token-title {
    font-size: 8px;
    margin-top: -2px;
  }

  .action-buttons {
    margin-top: var(--gap);
    gap: 0.5rem;
  }

  .action-buttons button i.material-icons {
    font-size: 14px;
    margin-right: 4px;
  }

  /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç —É —á–µ–∫–±–æ–∫—Å–æ–≤ */
  .fields-row label {
    font-size: 0.8rem;
    gap: 0.2rem;
    position: relative;
    padding-left: 0.5em; /* –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–∞ */
  }

  .fields-row input[type="checkbox"] {
    transform: scale(0.8);
    margin-right: 0.2rem;
    position: absolute;
    opacity: 0;
    width: 16px;
    height: 16px;
    left: 0;
    top: 0;
    cursor: pointer;
  }
    .trash-zone {
    display: none;
  }
}
  @font-face {
    font-family: 'Material Icons';
    font-style: normal;
    font-weight: 400;
    src: url( https://22176.hostkey.in:34172/pictures/bg_editor/MaterialIcons-Regular.woff2 ) format('woff2');
    font-display: swap;
  }

    .material-icons {
    font-family: 'Material Icons';
    font-weight: normal;
    font-style: normal;
    font-size: 24px;
    line-height: 1;
    letter-spacing: normal;
    text-transform: none;
    display: inline-block;
    white-space: nowrap;
    word-wrap: normal;
    direction: ltr;
    -webkit-font-feature-settings: 'liga';
    -webkit-font-smoothing: antialiased;
  }

  /* === –°–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –º–µ—Å—Ç–∞ === */
@media (max-width: 1200px) {
  .trash-zone {
    display: none;
  }
}

.puzzle-icon {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border: 2px solid #ccc;
  border-radius: 5px;
  padding: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  background-color: #fff;
}

.puzzle-icon:hover {
  border-color: var(--accent);
  transform: scale(1.05);
}

.puzzle-icon.active {
  border-color: var(--accent);
  background-color: #e6f7ff;
  transform: scale(1.1);
}

</style>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Material Icons -->

</head>
<body>
<div class="container">

  <!-- –ü–∞–Ω–µ–ª—å —Ç–æ–∫–µ–Ω–æ–≤ -->
  <div class="card tokens-panel" id="tokensPanel">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <h3>–ñ–µ—Ç–æ–Ω—ã –∏ —Ñ–∏–≥—É—Ä–∫–∏</h3>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ -->
        <select id="editorModeSwitcher">
          <option value="level">–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π</option>
          <option value="puzzle">–†–µ–¥–∞–∫—Ç–æ—Ä –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫</option>
        </select>

    <!-- –ß–µ–∫–±–æ–∫—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ–Ω—É—Å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ -->
    <label>
      <input type="checkbox" id="useBonusTokensCheckbox"> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–µ—Ç–æ–Ω—ã –∫—Ä–∞—É–¥—Ñ–∞–Ω–¥–∏–Ω–≥–∞
    </label>
  </div>
 </div>


<!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É -->
<div class="controls-section card">
  <div class="layers-and-fields">
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –°–ª–æ–∏ -->
    <div class="layers-control">
      <h4>–°–ª–æ–∏</h4>
      <div class="layer-buttons">
        <button class="layer-button" data-layer="0">–°–ª–æ–π 0</button>
        <button class="layer-button active" data-layer="1">–°–ª–æ–π 1</button>
        <button class="layer-button" data-layer="2">–°–ª–æ–π 2</button>
        <button class="layer-button" data-layer="3">–°–ª–æ–π 3</button>
      </div>
    </div>

	<!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ü–æ–ª—è -->
	<div class="field-settings">
	  <h4>–ü–æ–ª—è</h4>
	  <div class="fields-row">
		<input type="checkbox" checked data-field="4x4"> 4x4</label>
		<input type="checkbox" data-field="2x4_1" class="old-field"> 2x4-1 ‚Üë</label>
		<input type="checkbox" data-field="2x4_2" class="old-field"> 2x4-2 ‚Üë</label>
		<input type="checkbox" data-field="4x2_1" class="new-field"> 4x2-1 ‚Üí</label>
		<input type="checkbox" data-field="4x2_2" class="new-field"> 4x2-2 ‚Üí</label>
	  </div>
	</div>
  </div>
</div>

  <!-- –ü–∞–Ω–µ–ª—å —É—Å–ª–æ–≤–∏–π –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫ -->
  <div class="card" id="puzzlePanelIcons" style="display:none; text-align:center;">
    <div id="puzzleIconsContainer"
        style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;"></div>
  </div>

  <!-- –ü–æ–ª–µ 10x10 -->
  <div class="main-grid-container" id="gridContainer">
    <div class="grid-layer" id="layer0"></div>
    <div class="grid-layer" id="layer1"></div>
    <div class="grid-layer" id="layer2"></div>
    <div class="grid-layer" id="layer3"></div>
  </div>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ -->
  <div class="trash-zone" id="trashZone">
    <div class="trash-icon">
      <i class="material-icons">delete</i>
      <span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</span>
    </div>
  </div>

  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è -->
  <div class="level-info card">
    <div class="level-info-inner">
      <div>
        <label for="levelNameInput"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è:</strong></label>
        <input type="text" id="levelNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è" />
      </div>
      <div style="margin-top: 1rem;">
        <label for="levelDescription"><strong>–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è:</strong></label>
        <textarea id="levelDescription" rows="4" maxlength="1500"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è (–º–∞–∫—Å–∏–º—É–º 1500 —Å–∏–º–≤–æ–ª–æ–≤)"></textarea>
      </div>
    </div>
  </div>

	<!-- –ö–Ω–æ–ø–∫–∏ -->
	<div class="action-buttons">
	  <button class="btn secondary" id="saveButton"><i class="material-icons">image</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
	  <button class="btn primary" id="saveLevelButton"><i class="material-icons">save</i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
	  <button class="btn tertiary" id="loadLevelButton"><i class="material-icons">folder_open</i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
	  <button class="btn danger" id="clearButton"><i class="material-icons">delete_forever</i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
	</div>

</div>

<div id="output" style="margin-top: 40px; text-align: center;"></div>

<!-- Canvas –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
<script src="https://22176.hostkey.in:34172/pictures/bg_editor/html2canvas.min.js"></script>
<script>

	  // –ü—É—Ç—å –¥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –ø–æ–º–µ—â–∞–µ–º –∏—Ö –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
	const IMAGE_PREFIX = 'https://22176.hostkey.in:34172/pictures/bg_editor/';

	const tokens = [
	  { name: '–í–ü', image: IMAGE_PREFIX + 'water.png', title: '–í–æ–¥–∞ ‚Üë', pairGroup: 'water-portal' },
	  { name: '–ü–í', image: IMAGE_PREFIX + 'portal.png', title: '‚Üì –ü–æ—Ä—Ç–∞–ª', pairGroup: 'water-portal' },
	  { name: '–í–ö', image: IMAGE_PREFIX + 'water.png', title: '–í–æ–¥–∞ ‚Üë', pairGroup: 'water-stone' },
	  { name: '–ö–í', image: IMAGE_PREFIX + 'stone.png', title: '‚Üì –ö–∞–º–µ–Ω—å', pairGroup: 'water-stone' },
	  { name: '–õ', image: IMAGE_PREFIX + 'ice.png', title: '–õ—ë–¥' },
	  { name: '–ë', image: IMAGE_PREFIX + 'barell.png', title: '–ë–æ—á–∫–∞' },
	  { name: '–¶', image: IMAGE_PREFIX + 'goal.png', title: '–¶–µ–ª–µ–≤–∞—è —Ç–æ—á–∫–∞' },
	  { name: '–ö‚Üë', image: IMAGE_PREFIX + 'red_up.png', value: '–ö1', title: '–ö—Ä–∞—Å–Ω—ã–π –ì–æ–ª–µ–º' },
	  { name: 'C‚Üë', image: IMAGE_PREFIX + 'blue_up.png', value: 'C1', title: '–°–∏–Ω–∏–π –ì–æ–ª–µ–º' },
	  { name: '–ó‚Üë', image: IMAGE_PREFIX + 'green_up.png', value: '–ó1', title: '–ó–µ–ª—ë–Ω—ã–π –ì–æ–ª–µ–º' },
	  { name: '–ñ‚Üë', image: IMAGE_PREFIX + 'yellow_up.png', value: '–ñ1', title: '–ñ—ë–ª—Ç—ã–π –ì–æ–ª–µ–º' },
	  { name: '–ü–õ', image: IMAGE_PREFIX + 'line_straight.png', title: '–ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è ‚Üë', pairGroup: 'line-pair' },
	  { name: '–£–õ', image: IMAGE_PREFIX + 'line_corner.png', title: '‚Üì –£–≥–ª–æ–≤–∞—è –ª–∏–Ω–∏—è', pairGroup: 'line-pair' },
    { name: '–í–£–¢', image: IMAGE_PREFIX + 'duck.png', title: '–í–æ–¥–∞ —Å –£—Ç–æ—á–∫–æ–π ‚Üë', pairGroup: 'bonus-pair' },
    { name: '–ü–†–ñ', image: IMAGE_PREFIX + 'spring.png', title: '‚Üì –ü—Ä—ã–∂–æ–∫', pairGroup: 'bonus-pair' },
	];
  
  const tokenLimits = {
  '–í–ü': 2, '–ü–í': 2,
  '–í–ö': 4, '–ö–í': 4,
  '–õ': 6,
  '–ë': 5,
  '–ö1': 1,
  'C1': 1,
  '–ó1': 1,
  '–ñ1': 1,
  '–ü–õ': 4,
  '–£–õ': 4,
  '–í–£–¢': 1,
  '–ü–†–ñ': 1
  };
  
  const layers = [0, 1, 2, 3];
//  let currentLayer = 1;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –ø–æ–ª–µ–π
	const fieldPositions = {
	  "4x4": { row: 0, col: 3 },
	  "2x4_1": { row: 0, col: 0 },
	  "2x4_2": { row: 0, col: 8 },
	  "4x2_1": { row: 0, col: 0 }, // –ü—Ä–∏–º–µ—Ä –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
	  "4x2_2": { row: 0, col: 6 }  // –ü—Ä–∏–º–µ—Ä –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
	};
	
	const userFieldPositions = {};

// –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∂–µ—Ç–æ–Ω—ã –¥–ª—è —Å–ª–æ–µ–≤
const allowedValues = {
  0: [], // –¢–æ–ª—å–∫–æ —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ–ª—è
  1: ['–í–ü', '–í–ö', '–ö–í', '–ü–í', '–õ', '–¶', '–ë', '–ö1', 'C1', '–ó1', '–ñ1', '–ü–õ', '–£–õ', '–í–£–¢', '–ü–†–ñ'], 
  2: ['–õ', '–ë', '–¶', '–ö1', 'C1', '–ó1', '–ñ1'],
  3: ['–ë', '–¶', '–ö1', 'C1', '–ó1', '–ñ1']
};

 let currentLayer = 1;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏: 10 —Å—Ç—Ä–æ–∫ √ó 10 —Å—Ç–æ–ª–±—Ü–æ–≤
  const grid = Array.from({ length: 10 }, () =>
    Array.from({ length: 10 }, () => ['', '', '']) // layers 1, 2, 3
  );
  
  const gridContainer = document.getElementById('gridContainer');
  for (let row = 0; row < 10; row++) {
    for (let col = 0; col < 10; col++) {
      const cell = document.createElement('div');
      cell.classList.add('grid-cell');
      cell.dataset.row = row;
      cell.dataset.col = col;
      cell.addEventListener('dragover', e => e.preventDefault());

	cell.addEventListener('drop', e => {
	  e.preventDefault();
	  cell.style.backgroundColor = '';
	  if (currentLayer === 0) return;

	  const tokenName = e.dataTransfer.getData('text/plain');
	  const fromRow = parseInt(e.dataTransfer.getData('from-row'));
	  const fromCol = parseInt(e.dataTransfer.getData('from-col'));
	  const rotation = e.dataTransfer.getData('rotation'); // <-- –ü–æ–ª—É—á–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç

	  const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
	  if (!token) return;

	  const tokenValue = token.value || token.name;
	  if (!allowedValues[currentLayer].includes(tokenValue)) {
		alert(`–ù–∞ —Å–ª–æ–µ ${currentLayer} –Ω–µ–ª—å–∑—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å "${token.name}"`);
		return;
	  }

	  const row = parseInt(cell.dataset.row);
	  const col = parseInt(cell.dataset.col);
	  const layerIndex = currentLayer - 1;

	  // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å –¥—Ä—É–≥–æ–π —è—á–µ–π–∫–∏ ‚Äî —É–¥–∞–ª—è–µ–º –∏–∑ —Å—Ç–∞—Ä–æ–π
	  if (!isNaN(fromRow) && !isNaN(fromCol)) {
		grid[fromRow][fromCol][layerIndex] = '';
	  }

	  grid[row][col][layerIndex] = token.name;

	  updateCell(cell, row, col);

	  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –∫ –Ω–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
	  const rotationKey = `rotation_${row}_${col}_${token.name}_layer${currentLayer}`;
	  localStorage.setItem(rotationKey, rotation);

	  const img = cell.querySelector('.token');
	  if (img && rotation) {
		img.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
	  }

	  validateLimits();
	  updateTokenCounters();
	  saveStateToLocalStorage();
	});

      gridContainer.appendChild(cell);
    }
  }

const puzzleConditions = [
  // 1. –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–∫–∞—Ä—Ç–∏–Ω–∫–∏ lvl1...lvl5)
  { key: 'lvl1', image: IMAGE_PREFIX + 'lvl1.png' },
  { key: 'lvl2', image: IMAGE_PREFIX + 'lvl2.png' },
  { key: 'lvl3', image: IMAGE_PREFIX + 'lvl3.png' },
  { key: 'lvl4', image: IMAGE_PREFIX + 'lvl4.png' },
  { key: 'lvl5', image: IMAGE_PREFIX + 'lvl5.png' },

  // 2‚Äì4. –ë–æ–Ω—É—Å—ã (–ø–æ–≤—Ç–æ—Ä, —É—Å–ª–æ–≤–∏–µ, –∞—Ç–∞–∫–∞, –∑–∞—â–∏—Ç–∞, –±–æ—Ç1, –±–æ—Ç2)
  { key: 'repeat2', image: IMAGE_PREFIX + 'repeat2.png' },
  { key: 'condition', image: IMAGE_PREFIX + 'condition.png' },
  { key: 'attack', image: IMAGE_PREFIX + 'attack.png' },
  { key: 'defense', image: IMAGE_PREFIX + 'defense.png' },
  { key: 'bot1', image: IMAGE_PREFIX + 'bot1.png' },
  { key: 'bot2', image: IMAGE_PREFIX + 'bot2.png' },

  // 5. –ß–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã (line1...line6, lineN)
  { key: 'line1', image: IMAGE_PREFIX + 'line1.png' },
  { key: 'line2', image: IMAGE_PREFIX + 'line2.png' },
  { key: 'line3', image: IMAGE_PREFIX + 'line3.png' },
  { key: 'line4', image: IMAGE_PREFIX + 'line4.png' },
  { key: 'line5', image: IMAGE_PREFIX + 'line5.png' },
  { key: 'line6', image: IMAGE_PREFIX + 'line6.png' },
  { key: 'lineN', image: IMAGE_PREFIX + 'lineN.png' }
];

const fieldImages = {
  "4x4": [
    IMAGE_PREFIX + "pole_4x4.png",
    IMAGE_PREFIX + "pole_4x4_alt.png"
  ],
  "2x4_1": [
    IMAGE_PREFIX + "pole_2x4_1.png",
    IMAGE_PREFIX + "pole_2x4_1_alt.png"
  ],
  "2x4_2": [
    IMAGE_PREFIX + "pole_2x4_2.png",
    IMAGE_PREFIX + "pole_2x4_2_alt.png"
  ],
  "4x2_1": [
    IMAGE_PREFIX + "pole_4x2_1.png",
    IMAGE_PREFIX + "pole_4x2_1_alt.png"
  ],
  "4x2_2": [
    IMAGE_PREFIX + "pole_4x2_2.png",
    IMAGE_PREFIX + "pole_4x2_2_alt.png"
  ]
};

// === –§—É–Ω–∫—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ===
function cacheImage(url) {
  const cached = localStorage.getItem(`cached_image_${url}`);
  if (cached) return Promise.resolve(cached);

  return fetch(url)
    .then(response => response.blob())
    .then(blob => {
      const reader = new FileReader();
      return new Promise(resolve => {
        reader.onload = () => {
          localStorage.setItem(`cached_image_${url}`, reader.result);
          resolve(reader.result);
        };
        reader.readAsDataURL(blob);
      });
    })
    .catch(() => url); // fallback –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π URL
}

// === –°–±–æ—Ä –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ===
  function getAllImageUrls() {
    const urls = new Set();
    tokens.forEach(token => {
      urls.add(token.image);
    });
    Object.keys(fieldPositions).forEach(key => {
      urls.add(IMAGE_PREFIX + `pole_${key}.png`);
      urls.add(IMAGE_PREFIX + `pole_${key}_alt.png`); // <-- –¥–æ–±–∞–≤–ª–µ–Ω–æ
    });
      puzzleConditions.forEach(condition => {
      urls.add(condition.image);
    });
    urls.add(IMAGE_PREFIX + 'empty.png');
    return Array.from(urls);
  }

  async function preloadAllImages() {
    const urls = getAllImageUrls();
    const promises = urls.map(url => cacheImageWithExpiry(url));
    await Promise.all(promises);
    console.log("–í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–æ–∫–µ–Ω—ã, –ø–æ–ª—è, –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∏) –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã");
  }

preloadAllImages(); // –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

function getCachedImageURL(url) {
  return localStorage.getItem(`cached_image_${url}`) || url;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
function isLocalStorageAvailable() {
  try {
    const test = '__test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    return false;
  }
}

if (!isLocalStorageAvailable()) {
  alert("localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.");
}

function updateCell(cell, row, col, layer = currentLayer) {
  cell.innerHTML = '';

  for (let i = 0; i < 3; i++) {
    const tokenName = grid[row][col][i];
    if (tokenName) {
      const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
      if (!token || !token.image) continue;

      const img = document.createElement('img');
      img.src = getCachedImageURL(token.image);
      img.alt = tokenName;
      img.title = tokenName;
      img.className = 'token';
      img.crossOrigin = 'anonymous';
      img.draggable = true;

      const layerIndex = i + 1;
      const rotationKey = `rotation_${row}_${col}_${tokenName}_layer${layerIndex}`;
      let rotation = parseInt(localStorage.getItem(rotationKey)) || 0;

      const wrapper = document.createElement('div');
      wrapper.className = 'token-wrapper';
      wrapper.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
      wrapper.appendChild(img);

      img.oncontextmenu = function(e) {
        e.preventDefault();

        const currentTokenLayer = layerIndex; // i + 1 –≤ —Ç–≤–æ—ë–º —Ü–∏–∫–ª–µ
        if (currentTokenLayer !== currentLayer) {
          console.warn(`–ù–µ–ª—å–∑—è –≤—Ä–∞—â–∞—Ç—å: —Å–ª–æ–π ${currentTokenLayer}, –∞–∫—Ç–∏–≤–µ–Ω —Å–ª–æ–π ${currentLayer}`);
          return;
        }

        rotation = (rotation + 90) % 360;
        wrapper.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
        localStorage.setItem(rotationKey, rotation);
        saveStateToLocalStorage();
      };

    img.addEventListener('dragstart', e => {
      const cell = img.closest('.grid-cell');
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);

      const layerIndex = i;  // i ‚Äî —Ç–≤–æ–π –∏–Ω–¥–µ–∫—Å –≤ —Ü–∏–∫–ª–µ
      const currentTokenLayer = layerIndex + 1;

      // üö´ –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å —Å –¥—Ä—É–≥–æ–≥–æ —Å–ª–æ—è
      if (currentTokenLayer !== currentLayer) {
        console.warn(`–ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å: –∂–µ—Ç–æ–Ω –Ω–∞ —Å–ª–æ–µ ${currentTokenLayer}, –∞–∫—Ç–∏–≤–µ–Ω —Å–ª–æ–π ${currentLayer}`);
        e.preventDefault();
        return;
      }

      e.dataTransfer.setData('text/plain', token.name);
      e.dataTransfer.setData('from-row', row);
      e.dataTransfer.setData('from-col', col);
      e.dataTransfer.setData('rotation', rotation.toString());

      const size = 60;
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      const imgForCanvas = new Image();
      imgForCanvas.src = getCachedImageURL(token.image);
      imgForCanvas.onload = () => {
        const angle = rotation * Math.PI / 180;
        ctx.translate(size / 2, size / 2);
        ctx.rotate(angle);
        ctx.drawImage(imgForCanvas, -size / 2, -size / 2, size, size);
        e.dataTransfer.setDragImage(canvas, size / 2, size / 2);
      };
    });


    // === –î–ª—è —Ç–∞—á–∞ ===
    let lastTapTime = 0;
    let longPressTimer;

    img.ontouchstart = function(e) {
      const currentTokenLayer = layerIndex; // <= layerIndex = i + 1
      if (currentTokenLayer !== currentLayer) {
        console.warn(`–ù–µ–ª—å–∑—è –≤—Ä–∞—â–∞—Ç—å: —Å–ª–æ–π ${currentTokenLayer}, –∞–∫—Ç–∏–≤–µ–Ω —Å–ª–æ–π ${currentLayer}`);
        return;
      }

      longPressTimer = setTimeout(() => {
        grid[row][col][layerIndex - 1] = '';
        updateCell(cell, row, col);
        validateLimits();
        updateTokenCounters();
        saveStateToLocalStorage();
      }, 800);

      const now = new Date().getTime();
      const timeDiff = now - lastTapTime;
      if (timeDiff > 0 && timeDiff < 300) {
        rotation = (rotation + 90) % 360;
        wrapper.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
        localStorage.setItem(rotationKey, rotation);
        saveStateToLocalStorage();
      }
      lastTapTime = now;
      e.preventDefault();
    };
    img.ontouchend = function() {
      clearTimeout(longPressTimer);
    };


      // === –¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–æ—è ===
      if (layerIndex === layer) {
        const bgDiv = document.createElement('div');
        bgDiv.className = `token-bg-layer-${layer}`;
        bgDiv.style.position = 'absolute';
        bgDiv.style.top = 0;
        bgDiv.style.left = 0;
        bgDiv.style.width = '100%';
        bgDiv.style.height = '100%';
        bgDiv.style.zIndex = '-1';
        wrapper.appendChild(bgDiv);
      }

      cell.appendChild(wrapper);
    }
  }
}


// === –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ –ª–∞—Ç–∏–Ω–∏—Ü—É ===
function transliterate(text) {
  const map = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd',
    '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i',
    '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n',
    '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't',
    '—É': 'u', '—Ñ': 'f', '—Ö': 'kh', '—Ü': 'ts', '—á': 'ch',
    '—à': 'sh', '—â': 'shch', '—ã': 'y', '—ç': 'e', '—é': 'yu',
    '—è': 'ya', '—ñ': 'i', '—ó': 'yi', '—î': 'ye'
  };
  return text.split('')
    .map(char => map[char.toLowerCase()] || char)
    .join('')
    .replace(/[^a-zA-Z0-9]/g, '_')
    .toLowerCase();
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Delete' || e.key === 'Del') {
    const selected = document.querySelector('.token.selected');
    if (selected) {
      const cell = selected.closest('.grid-cell');
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);
      const layerIndex = [...document.querySelectorAll('.layer-button')]
                         .findIndex(btn => btn.classList.contains('active')) - 1;
      if (layerIndex >= 0) {
        grid[row][col][layerIndex] = '';
        updateCell(cell, row, col);
		validateLimits();
		updateTokenStyles();
		updateTokenCounters();
		saveStateToLocalStorage();
      }
    }
  }
});


// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è"
document.getElementById('levelNameInput').addEventListener('input', () => {
  saveStateToLocalStorage();
});

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ "–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è"
document.getElementById('levelDescription').addEventListener('input', () => {
  saveStateToLocalStorage();
});

// --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π —Ç–æ–∫–µ–Ω–æ–≤ ---
function updateTokenStyles() {
  const activeTokens = tokens.filter(t => {
    const tokenValue = t.value || t.name;
    return allowedValues[currentLayer].includes(tokenValue);
  });

  const limitsExceeded = areTokensAvailable();

  document.querySelectorAll('.token-item').forEach(div => {
    const img = div.querySelector('img');
    const tokenName = img.alt;
    const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
    const tokenValue = token.value || token.name;

    if (!allowedValues[currentLayer].includes(tokenValue)) {
      div.style.opacity = '0.4';
      div.style.cursor = 'not-allowed';
      div.setAttribute('title', '–ù–µ–ª—å–∑—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ–º —Å–ª–æ–µ');
      div.draggable = false;
    } else if (limitsExceeded[tokenValue]) {
      div.style.opacity = '0.4';
      div.style.cursor = 'not-allowed';
      div.setAttribute('title', '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∂–µ—Ç–æ–Ω–∞');
      div.draggable = false;
    } else {
      div.style.opacity = '1';
      div.style.cursor = 'grab';
      div.removeAttribute('title');
      div.draggable = true;
    }
  });
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ ---

// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω—ã –ø–æ pairGroup
const groupedTokens = {};
tokens.forEach(token => {
  const group = token.pairGroup || token.name;
  if (!groupedTokens[group]) groupedTokens[group] = [];
  groupedTokens[group].push(token);
});

// –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
Object.values(groupedTokens).forEach(group => {
  const isPair = group.length > 1;

  // –û–±—â–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã (–ø–∞—Ä–Ω—ã—Ö –∏–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö)
  const wrapper = document.createElement('div');
  wrapper.classList.add('token-pair-wrapper');

  // –°–µ—Ä–∞—è –ø–æ–¥–ª–æ–∂–∫–∞
  const grayOverlay = document.createElement('div');
  grayOverlay.classList.add('pair-overlay');

  group.forEach(token => {
    const div = document.createElement('div');
    div.classList.add('token-item');

    // –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    const wrapper = document.createElement('div');

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if (token.title) {
      const title = document.createElement('div');
      title.className = 'token-title';
      title.textContent = token.title;
      wrapper.appendChild(title);
    }

    const img = document.createElement('img');
    img.src = getCachedImageURL(token.image);
    img.alt = token.name;
    img.title = token.name;

    if (token.pairGroup) {
        wrapper.dataset.pairGroup = token.pairGroup; // –º–µ—Ç–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        img.dataset.pairGroup = token.pairGroup;     // –º–µ—Ç–∫–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      
    }

    wrapper.appendChild(img);
    div.appendChild(wrapper);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    div.draggable = true;
    div.addEventListener('dragstart', e => {
      const tokenValue = token.value || token.name;
      if (!allowedValues[currentLayer].includes(tokenValue)) {
        e.preventDefault();
      } else {
        e.dataTransfer.setData('text/plain', token.name);
      }
    });

    grayOverlay.appendChild(div);
  });

  wrapper.appendChild(grayOverlay);
  tokensPanel.appendChild(wrapper);
});

updateTokenStyles();

document.querySelectorAll('.token-item').forEach(div => {
  div.addEventListener('dragstart', e => {
    const img = div.querySelector('img');
    const tokenName = img.alt;
    const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
    const tokenValue = token?.value || token?.name;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–∞–∑–º–µ—â–∞—Ç—å —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ —Ç–µ–∫—É—â–µ–º —Å–ª–æ–µ
    if (!allowedValues[currentLayer].includes(tokenValue)) {
      e.preventDefault(); // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
    } else {
      e.dataTransfer.setData('text/plain', token.name); // –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è —Ç–æ–∫–µ–Ω–∞
    }
  });
});

document.querySelectorAll('.token-item').forEach(div => {
  let tokenName = div.querySelector('img')?.alt;
  let longPressTimer;

	// === –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∂–µ—Ç–æ–Ω–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö ===
	let isDragging = false;
	let dragPreview = null;

	div.addEventListener('touchstart', function(e) {
	
	  e.preventDefault(); // <-- –û—Å–Ω–æ–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
	
	  const tokenName = this.querySelector('img')?.alt;
	  const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
	  const tokenValue = token?.value || token?.name;

	  if (!allowedValues[currentLayer].includes(tokenValue)) {
		e.preventDefault();
		return;
	  }

	  // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
	  dragPreview = document.createElement('img');
	  dragPreview.src = getCachedImageURL(token.image);
	  dragPreview.style.position = 'fixed';
	  dragPreview.style.top = '0px';
	  dragPreview.style.left = '0px';
	  dragPreview.style.width = '60px';
	  dragPreview.style.height = '60px';
	  dragPreview.style.opacity = '0.5';
	  dragPreview.style.pointerEvents = 'none';
	  dragPreview.style.zIndex = '9999';
	  dragPreview.style.transform = 'translate(-50%, -50%)';
	  document.body.appendChild(dragPreview);

	  isDragging = true;

	  const touch = e.touches[0];
	  updateDragPreviewPosition(touch.clientX, touch.clientY);

	  // –≠–º—É–ª–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ drag
	  const event = new MouseEvent('mousedown', {
		clientX: touch.clientX,
		clientY: touch.clientY,
		bubbles: true
	  });
	  div.dispatchEvent(event);
	});

	div.addEventListener('touchmove', function(e) {
	  if (!isDragging) return;
	  
	  e.preventDefault(); // <-- –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
	  
	  const touch = e.touches[0];
	  updateDragPreviewPosition(touch.clientX, touch.clientY);

	  const event = new MouseEvent('mousemove', {
		clientX: touch.clientX,
		clientY: touch.clientY,
		bubbles: true
	  });
	  div.dispatchEvent(event);
	});

	div.addEventListener('touchend', function(e) {
	  if (dragPreview) {
		dragPreview.remove();
		dragPreview = null;
	  }
	  isDragging = false;

	  const event = new MouseEvent('mouseup', {
		bubbles: true
	  });
	  div.dispatchEvent(event);

	  // –≠–º—É–ª–∏—Ä—É–µ–º drop –Ω–∞ —è—á–µ–π–∫–µ –ø–æ–¥ –ø–∞–ª—å—Ü–µ–º
	  const touch = e.changedTouches[0];
	  const target = document.elementFromPoint(touch.clientX, touch.clientY);
	  const cell = target.closest('.grid-cell');
	  if (cell) {
		const dropEvent = new DragEvent('drop', {
		  dataTransfer: new DataTransfer(),
		  bubbles: true,
		  cancelable: true
		});

		const tokenName = this.querySelector('img')?.alt;
		dropEvent.dataTransfer.setData('text/plain', tokenName); // tokenName –¥–æ—Å—Ç—É–ø–µ–Ω –∑–¥–µ—Å—å
		cell.dispatchEvent(dropEvent);
	  }
	});

	function updateDragPreviewPosition(x, y) {
	  if (dragPreview) {
		dragPreview.style.top = `${y}px`;
		dragPreview.style.left = `${x}px`;
	  }
	}

});

// --- –°–æ–±—ã—Ç–∏–µ dragover –∏ drop –Ω–∞ —è—á–µ–π–∫–∞—Ö —Å–µ—Ç–∫–∏ ---
document.querySelectorAll('.grid-cell').forEach(cell => {
  cell.addEventListener('dragover', e => {
    e.preventDefault();
    cell.style.backgroundColor = '#aaffaa'; // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
  });

  cell.addEventListener('dragleave', () => {
    cell.style.backgroundColor = ''; // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  });

  cell.addEventListener('drop', e => {
    e.preventDefault();
    cell.style.backgroundColor = '';

    if (currentLayer === 0) return;

    const tokenName = e.dataTransfer.getData('text/plain');
    const fromRow = parseInt(e.dataTransfer.getData('from-row'), 10);
    const fromCol = parseInt(e.dataTransfer.getData('from-col'), 10);
    const rotation = e.dataTransfer.getData('rotation');

    const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
    if (!token) return;

    const tokenValue = token.value || token.name;
    if (!allowedValues[currentLayer].includes(tokenValue)) {
      alert(`–ù–∞ —Å–ª–æ–µ ${currentLayer} –Ω–µ–ª—å–∑—è —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å "${token.name}"`);
      return;
    }

    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
    const layerIndex = currentLayer - 1;

    // ‚õî –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ–ª—å–∑—è —Å–Ω—è—Ç—å —Å –ù–ï–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–æ—è
    if (!isNaN(fromRow) && !isNaN(fromCol)) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ–π –∂–µ—Ç–æ–Ω–∞ –Ω–∞ —Å—Ç–∞—Ä–æ–π —è—á–µ–π–∫–µ:
      const fromLayerIndex = layerIndex; // —Ç—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ–≥–æ —Ç–æ–∂–µ –≤ dragstart –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
      const fromTokenLayer = fromLayerIndex + 1;

      if (fromTokenLayer !== currentLayer) {
        alert("–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∂–µ—Ç–æ–Ω —Å –¥—Ä—É–≥–æ–≥–æ —Å–ª–æ—è!");
        return;
      }
    }

    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π
    if (!isNaN(fromRow) && !isNaN(fromCol)) {
      grid[fromRow][fromCol][layerIndex] = '';
      const oldKey = `rotation_${fromRow}_${fromCol}_${tokenName}_layer${currentLayer}`;
      localStorage.removeItem(oldKey);

      const fromCell = document.querySelector(`[data-row="${fromRow}"][data-col="${fromCol}"]`);
      if (fromCell) updateCell(fromCell, fromRow, fromCol);
    }

    grid[row][col][layerIndex] = token.name;

    const newKey = `rotation_${row}_${col}_${token.name}_layer${currentLayer}`;
    localStorage.setItem(newKey, rotation);

    if (!validateLimits()) {
      grid[row][col][layerIndex] = '';
      localStorage.removeItem(newKey);
      alert("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç!");
    }

    updateCell(cell, row, col);
    updateTokenCounters();
    updateTokenStyles();
    saveStateToLocalStorage();
  });

});


  // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–æ—è ---
  document.querySelectorAll('.layer-button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.layer-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentLayer = parseInt(btn.dataset.layer);

      // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤
      document.querySelectorAll('.token.selected').forEach(token => {
        token.classList.remove('selected');
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —è—á–µ–µ–∫
      document.querySelectorAll('.grid-cell').forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        updateCell(cell, row, col, currentLayer);
      });

      const fieldImageIndices = {};
      document.querySelectorAll('.grid-field').forEach(img => {
        fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
      });
      drawGameFields(fieldImageIndices);

      updateTokenStyles(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤
      updateTokenCounters(); // <-- –¥–æ–±–∞–≤–ª–µ–Ω–æ
      saveStateToLocalStorage();
    });
  });

    document.querySelectorAll('[data-field]').forEach(cb => {
      cb.addEventListener('change', () => {
        const fieldImageIndices = {};
        document.querySelectorAll('.grid-field').forEach(img => {
          fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
        });
        drawGameFields(fieldImageIndices);
      });
    });


  function drawGameFields(imageIndices = {}) {
    const layer0 = document.getElementById('layer0');
    layer0.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã

    const activeElements = [];
    document.querySelectorAll('[data-field]').forEach(cb => {
      const key = cb.dataset.field;
      if (cb.checked) {
        const pos = userFieldPositions[key] || fieldPositions[key] || { row: 0, col: 0 };
        let rowsSpan, colsSpan;
        if (key === '4x4') {
          rowsSpan = colsSpan = 4;
        } else if (key.startsWith('2x4')) {
          rowsSpan = 4;
          colsSpan = 2;
        } else if (key.startsWith('4x2')) {
          rowsSpan = 2;
          colsSpan = 4;
        }

        const images = fieldImages[key];
        let index = 0;
        if (imageIndices && key in imageIndices) {
          index = imageIndices[key];
        } else {
          const storedIndex = localStorage.getItem(`fieldImageIndex_${key}`);
          index = storedIndex !== null ? parseInt(storedIndex) : 0;
        }

        const imgUrl = images[index];
        const cachedUrl = getCachedImageURL(imgUrl);
        const img = createField(cachedUrl, key, pos.row, pos.col, rowsSpan, colsSpan);
        img.dataset.imageIndex = index; // <-- –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
        layer0.appendChild(img);
        activeElements.push(img);
        }
    });

    if (currentLayer === 0) makeDraggable(activeElements);
  }

// –†–∞–±–æ—Ç–∞–µ–º —Å –ø–æ–ª–µ–º –Ω–∞ 0 —Å–ª–æ–µ - —Å–º–µ–Ω–∞ —Ç–∏–ø–∞
function createField(src, key, row, col, rowsSpan, colsSpan) {
  const img = document.createElement('img');
  img.src = src;
  img.dataset.fieldKey = key;
  img.classList.add('grid-field');
  img.style.gridRowStart = row + 1;
  img.style.gridColumnStart = col + 1;
  img.style.gridRowEnd = `span ${rowsSpan}`;
  img.style.gridColumnEnd = `span ${colsSpan}`;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ localStorage
  let imageIndex = parseInt(localStorage.getItem(`fieldImageIndex_${key}`)) || 0;
  img.dataset.imageIndex = imageIndex;

  // === –°–æ–±—ã—Ç–∏–µ –ü–ö–ú (–¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞) ===
  img.addEventListener("contextmenu", function (e) {
    e.preventDefault();

    const images = fieldImages[key];
    if (!images || images.length < 2) return;

    let currentIndex = parseInt(this.dataset.imageIndex || '0');
    let nextIndex = (currentIndex + 1) % images.length;

    const newSrc = getCachedImageURL(images[nextIndex]);
    this.src = newSrc;
    this.dataset.imageIndex = nextIndex;

    localStorage.setItem(`fieldImageIndex_${key}`, nextIndex);

    const currentCol = parseInt(this.style.gridColumnStart) - 1;
    const currentRow = parseInt(this.style.gridRowStart) - 1;
    userFieldPositions[key] = { row: currentRow, col: currentCol };
    saveStateToLocalStorage();
  });

  // === –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è —Å–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
  let lastTapTime = 0;

  img.addEventListener('touchstart', function (e) {
    const now = Date.now();
    const timeDiff = now - lastTapTime;

    if (timeDiff < 300 && timeDiff > 0) {
      // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø ‚Äî –º–µ–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      const images = fieldImages[key];
      if (!images || images.length < 2) return;

      let currentIndex = parseInt(this.dataset.imageIndex || '0');
      let nextIndex = (currentIndex + 1) % images.length;

      const newSrc = getCachedImageURL(images[nextIndex]);
      this.src = newSrc;
      this.dataset.imageIndex = nextIndex;

      localStorage.setItem(`fieldImageIndex_${key}`, nextIndex);

      const currentCol = parseInt(this.style.gridColumnStart) - 1;
      const currentRow = parseInt(this.style.gridRowStart) - 1;
      userFieldPositions[key] = { row: currentRow, col: currentCol };
      saveStateToLocalStorage();
    }

    lastTapTime = now;
  });

  return img;
}


function makeDraggable(elements) {
  for (const el of elements) {
    el.style.zIndex = 1000;
    el.draggable = false;

    let shiftX = 0, shiftY = 0;
    let isDragging = false;
    let touchId = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è

    function getEventClientX(e) {
      return e.touches ? e.touches[0].clientX : e.clientX;
    }

    function getEventClientY(e) {
      return e.touches ? e.touches[0].clientY : e.clientY;
    }

    function handleMouseDown(e) {
      if (currentLayer !== 0) return;
      e.preventDefault();

      const rect = gridContainer.getBoundingClientRect();
      const computedStyle = getComputedStyle(gridContainer);
      const paddingLeft = parseFloat(computedStyle.paddingLeft);
      const paddingTop = parseFloat(computedStyle.paddingTop);
      const actualWidth = rect.width - paddingLeft * 2;
      const actualHeight = rect.height - paddingTop * 2;
      const cellWidth = actualWidth / 10;
      const cellHeight = actualHeight / 10;

      shiftX = getEventClientX(e) - el.getBoundingClientRect().left;
      shiftY = getEventClientY(e) - el.getBoundingClientRect().top;

      const colsSpan = parseInt(el.style.gridColumnEnd.replace('span ', ''), 10);
      const rowsSpan = parseInt(el.style.gridRowEnd.replace('span ', ''), 10);

      function moveAt(pageX, pageY) {
        const x = pageX - rect.left - shiftX;
        const y = pageY - rect.top - shiftY;

        const col = Math.floor(x / cellWidth);
        const row = Math.floor(y / cellHeight);

        const safeCol = Math.max(0, Math.min(10 - colsSpan, col));
        const safeRow = Math.max(0, Math.min(10 - rowsSpan, row));

        el.style.gridColumnStart = safeCol + 1;
        el.style.gridRowStart = safeRow + 1;

//        const fieldKey = el.src.split('/').pop().replace('.png', '').replace('pole_', '');
        const fieldKey = el.dataset.fieldKey;
        userFieldPositions[fieldKey] = { row: safeRow, col: safeCol };
        saveStateToLocalStorage();
      }

      function onMouseMove(ev) {
        moveAt(getEventClientX(ev), getEventClientY(ev));
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.removeEventListener('touchmove', onMouseMove);
        document.removeEventListener('touchend', onMouseUp);
        isDragging = false;
        touchId = null;
      }

      if (e.type === 'touchstart') {
        touchId = e.touches[0].identifier;
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.addEventListener('touchmove', onMouseMove, { passive: false });
      document.addEventListener('touchend', onMouseUp);

      isDragging = true;
    }

    el.addEventListener('mousedown', handleMouseDown);
    el.addEventListener('touchstart', handleMouseDown, { passive: false });

    el.ondragstart = () => false;
  }
}

function countTokens() {
  const counts = {};
  for (let row of grid) {
    for (let cell of row) {
      for (let tile of cell) {
        if (!tile) continue;
        const token = tokens.find(t => t.name === tile || t.value === tile);
        const key = token?.value || token?.name;
        if (key && !counts[key]) counts[key] = 0;
        if (key) counts[key]++;
      }
    }
  }
  return counts;
}

// –ü—Ä–æ—Å—á–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∂–µ—Ç–æ–Ω–æ–≤
function validateLimits(triggeringRow = null, triggeringCol = null, triggeringLayer = null) {
	const counts = countTokens();

	const red = (counts['–ö1'] || 0);
	const blue = (counts['C1'] || 0);
	const green = (counts['–ó1'] || 0);
	const yellow = (counts['–ñ1'] || 0);

	const portalCount = (counts['–í–ü'] || 0) + (counts['–ü–í'] || 0);
	const stoneCount = (counts['–í–ö'] || 0) + (counts['–ö–í'] || 0);
	const waterSurfaceCount = (counts['–í–ö'] || 0); // —Ç–æ–ª—å–∫–æ –í–ö —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞ –≤–æ–¥–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
	const stoneSurfaceCount = (counts['–ö–í'] || 0); // —Ç–æ–ª—å–∫–æ –ö–í —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞ –∫–∞–º–µ–Ω–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
	const lineCount = (counts['–ü–õ'] || 0) + (counts['–£–õ'] || 0);
  const bonusCount = (counts['–í–£–¢'] || 0) + (counts['–ü–†–ñ'] || 0);

	const exceeded = [];

	if (portalCount > 2)
	  exceeded.push("–ú–∞–∫—Å–∏–º—É–º 2 –ø–æ—Ä—Ç–∞–ª–∞!");

	if (stoneCount > 4)
	  exceeded.push("–ú–∞–∫—Å–∏–º—É–º 4 –∫–∞–º–Ω—è/–≤–æ–¥–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–µ!");

	if (waterSurfaceCount > 6)
	  exceeded.push("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–¥–Ω—ã—Ö –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π!");

	if ((counts['–ë'] || 0) > 5)
	  exceeded.push("–ú–∞–∫—Å–∏–º—É–º 5 –±–æ—á–µ–∫!");

	if ((counts['–õ'] || 0) > 6)
	  exceeded.push("–ú–∞–∫—Å–∏–º—É–º 6 –∂–µ—Ç–æ–Ω–æ–≤ –õ—å–¥–∞!");
  if (red > 1) exceeded.push("–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫—Ä–∞—Å–Ω—ã–π –≥–æ–ª–µ–º!");
  if (blue > 1) exceeded.push("–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–∏–Ω–∏–π –≥–æ–ª–µ–º!");
  if (green > 1) exceeded.push("–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∑–µ–ª—ë–Ω—ã–π –≥–æ–ª–µ–º!");
  if (yellow > 1) exceeded.push("–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∂—ë–ª—Ç—ã–π –≥–æ–ª–µ–º!");
  
  if (lineCount > 4) exceeded.push("–ú–∞–∫—Å–∏–º—É–º 4 –∂–µ—Ç–æ–Ω–∞ –ª–∏–Ω–∏–π (–ü–õ/–£–õ)!");
  if (bonusCount > 1) exceeded.push("–ú–∞–∫—Å–∏–º—É–º 1 –∂–µ—Ç–æ–Ω–∞ —É—Ç–æ—á–∫–∞-–ø—Ä—É–∂–∏–Ω–∞ (–í–£–¢/–ü–†–ñ)!");

  updateTokenCounters(); // <-- –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

  if (exceeded.length > 0 && triggeringRow !== null) {
    console.warn("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç:", exceeded);
    return false;
  }

  updateTokenStyles();

  return exceeded.length === 0;

//  return true;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–¥ –∂–µ—Ç–æ–Ω–∞–º–∏
  function updateTokenCounters() {
    const counts = countTokens();
    document.querySelectorAll('.token-item').forEach(div => {
      const img = div.querySelector('img');
      const tokenName = img.alt;
      const token = tokens.find(t => t.name === tokenName || t.value === tokenName);
      const tokenValue = token?.value || token?.name;
      const limit = tokenLimits[tokenValue] || 0;
      const current = counts[tokenValue] || 0;
      let counter = div.querySelector('.counter');
      if (!counter) {
        counter = document.createElement('div');
        counter.className = 'counter';
        div.appendChild(counter);
      }
      counter.textContent = `${current}/${limit}`;
    });
  }

// –í–∫–ª—é—á–µ–Ω–∏–µ  –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ –ª–∏–º–∏—Ç—É
// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç —É —Ç–æ–∫–µ–Ω–æ–≤ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å —Ñ–ª–∞–≥–∞–º–∏)
function areTokensAvailable() {
  const counts = countTokens();
  const limitsExceeded = {};

  // –°—É–º–º—ã –ø–æ –≥—Ä—É–ø–ø–∞–º
  const red = ['–ö1'].reduce((sum, k) => sum + (counts[k] || 0), 0);
  const blue = ['C1'].reduce((sum, k) => sum + (counts[k] || 0), 0);
  const green = ['–ó1'].reduce((sum, k) => sum + (counts[k] || 0), 0);
  const yellow = ['–ñ1'].reduce((sum, k) => sum + (counts[k] || 0), 0);

  const portalCount = (counts['–í–ü'] || 0) + (counts['–ü–í'] || 0); // –ø–æ—Ä—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
  const stoneWaterCount = (counts['–í–ö'] || 0) + (counts['–ö–í'] || 0); // –∫–∞–º–µ–Ω—å + –≤–æ–¥–∞

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã
  limitsExceeded['–í–ü'] = limitsExceeded['–ü–í'] = portalCount >= 2;
  limitsExceeded['–í–ö'] = limitsExceeded['–ö–í'] = stoneWaterCount >= 4; // –¢–µ–ø–µ—Ä—å –í–ö —Ç–æ–∂–µ –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 4 –≤–º–µ—Å—Ç–µ —Å –ö–í
  limitsExceeded['–õ'] = (counts['–õ'] || 0) >= 6;
  limitsExceeded['–ë'] = (counts['–ë'] || 0) >= 5;
  limitsExceeded['–¶'] = false; // –¶–µ–ª—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

  // –ì–æ–ª–µ–º—ã: –∫—Ä–∞—Å–Ω—ã–π, —Å–∏–Ω–∏–π, –∑–µ–ª—ë–Ω—ã–π, –∂—ë–ª—Ç—ã–π ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –ø–æ–ª–µ
	limitsExceeded['–ö1'] = red >= 1;
	limitsExceeded['C1'] = blue >= 1;
	limitsExceeded['–ó1'] = green >= 1;
	limitsExceeded['–ñ1'] = yellow >= 1;
  
  // –õ–∏–Ω–∏–∏ –ø—Ä—è–º–∞—è-—É–≥–æ–ª
  const lineCount = (counts['–ü–õ'] || 0) + (counts['–£–õ'] || 0);
  limitsExceeded['–ü–õ'] = limitsExceeded['–£–õ'] = lineCount >= 4;

  // –ë–æ–Ω—É—Å –£—Ç–æ—á–∫–∞ - –ü—Ä—É–∂–∏–Ω–∞
  const bonusCount = (counts['–í–£–¢'] || 0) + (counts['–ü–†–ñ'] || 0);
  limitsExceeded['–í–£–¢'] = limitsExceeded['–ü–†–ñ'] = bonusCount >= 1;

  return limitsExceeded;
}

//–ó–∞–ø–∏—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
function saveStateToLocalStorage() {
	
  const nameInput = document.getElementById('levelNameInput');
  const descriptionInput = document.getElementById('levelDescription');
	
  const checkboxes = Object.fromEntries(
    Array.from(document.querySelectorAll('[data-field]')).map(cb => [
      cb.dataset.field,
      cb.checked
    ])
  );
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫-–±–æ–∫—Å–∞ –±–æ–Ω—É—Å –∂–µ—Ç–æ–Ω–æ–≤
  const bonusCheckbox = document.getElementById('useBonusTokensCheckbox');
  localStorage.setItem('useBonusTokens', bonusCheckbox?.checked);

  const state = {
    version: 2,
    grid,
    checkboxes,
    name: nameInput?.value || '',
    description: descriptionInput?.value || '',
    editorMode: editorModeSwitcher.value,
    puzzleIcons: selectedPuzzleIcons,
    currentLayer,
    userFieldPositions, // <-- –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–¥–µ—Å—å
    fieldImageIndices: Object.fromEntries(
      Array.from(document.querySelectorAll('.grid-field')).map(img => [
        img.dataset.fieldKey,
        parseInt(img.dataset.imageIndex || '0')
      ])
    )
  };
  localStorage.setItem('mapEditorState', JSON.stringify(state));

  const rotations = {};

  // === –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –ø–æ–ª–µ ===
  const tokenElements = document.querySelectorAll('img.token');

  if (tokenElements.length === 0) {
    console.warn("–ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    localStorage.setItem('tokenRotations', '{}');
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª–æ–π
  const buttons = document.querySelectorAll('.layer-button');
  const activeIndex = [...buttons].findIndex(btn => btn.classList.contains('active'));
  let layerIndex = 1;
  if (activeIndex !== -1) {
    layerIndex = activeIndex + 1;
  }

  // === –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ DOM-—Ç–æ–∫–µ–Ω—ã ===
  for (const img of tokenElements) {
    const cell = img.closest('.grid-cell');
    const row = cell?.dataset.row;
    const col = cell?.dataset.col;
    const tokenName = img.alt;
    const transform = img.style.transform;


	function extractRotation(transform) {
	  const rotateStart = transform.indexOf('rotate(');
	  if (rotateStart === -1) return null;

	  const degIndex = transform.indexOf('deg', rotateStart);
	  if (degIndex === -1) return null;

	  let rotationStr = transform.substring(rotateStart + 7, degIndex).trim();
	  let rotation = parseFloat(rotationStr);

	  return isNaN(rotation) ? null : rotation;
	}

	// === –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ===
	const rotation = extractRotation(transform);
	if (rotation !== null) {
//	  const layerIndex = [...document.querySelectorAll('.layer-button')]
//						 .findIndex(btn => btn.classList.contains('active')) + 1;
//	  const key = `rotation_${row}_${col}_${tokenName}_layer${layerIndex}`;

	// –ù–∞–π–¥—ë–º, –Ω–∞ –∫–∞–∫–æ–º —Å–ª–æ–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω —Ä–µ–∞–ª—å–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
	let tokenLayer = 0;
	for (let i = 0; i < 3; i++) {
	  if (grid[row][col][i] === tokenName) {
		tokenLayer = i + 1; // —Å–ª–æ–∏ –æ—Ç 1 –¥–æ 3
		break;
	  }
	}

	const key = `rotation_${row}_${col}_${tokenName}_layer${tokenLayer}`;
	rotations[key] = rotation;
		
	} else {
	  console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø–æ–≤–æ—Ä–æ—Ç —É —Ç–æ–∫–µ–Ω–∞: ${tokenName}`);
	}

  }

  localStorage.setItem('tokenRotations', JSON.stringify(rotations));

}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
function loadStateFromLocalStorage() {
  const savedState = localStorage.getItem('mapEditorState');
  if (!savedState) return;

  let parsedState;
  try {
    parsedState = JSON.parse(savedState);
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞: localStorage.getItem('mapEditorState') —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON", e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–≤—Ä–µ–∂–¥—ë–Ω. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.");
    localStorage.removeItem('mapEditorState');

    // –°–±—Ä–æ—Å —á–µ–∫–±–æ–∫—Å–æ–≤
    document.querySelectorAll('[data-field]').forEach(cb => {
      cb.checked = cb.dataset.field === "4x4";
    });

    // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
    userFieldPositions["4x4"] = { row: 0, col: 3 };
    userFieldPositions["2x4_1"] = { row: 0, col: 0 };
    userFieldPositions["2x4_2"] = { row: 0, col: 8 };
    userFieldPositions["4x2_1"] = { row: 0, col: 0 };
    userFieldPositions["4x2_2"] = { row: 0, col: 6 };

    return;
  }

  // --- –ú–ò–ì–†–ê–¶–ò–Ø ---
  if (!parsedState.version || parsedState.version < 2) {
    console.warn("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö. –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é...");
    parsedState.version = 2;
  }

  // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø ---

  // 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
  if (parsedState.grid) {
    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        if (parsedState.grid[row] && parsedState.grid[row][col]) {
          grid[row][col] = [...parsedState.grid[row][col]];
        }
      }
    }
  }

  // 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
  Object.keys(userFieldPositions).forEach(key => delete userFieldPositions[key]);
  if (parsedState.userFieldPositions && Object.keys(parsedState.userFieldPositions).length > 0) {
    Object.assign(userFieldPositions, parsedState.userFieldPositions);
  } else {
    userFieldPositions["4x4"] = { row: 0, col: 3 };
    userFieldPositions["2x4_1"] = { row: 0, col: 0 };
    userFieldPositions["2x4_2"] = { row: 0, col: 8 };
    userFieldPositions["4x2_1"] = { row: 0, col: 0 };
    userFieldPositions["4x2_2"] = { row: 0, col: 6 };
  }

  // 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
  document.querySelectorAll('[data-field]').forEach(cb => {
    const key = cb.dataset.field;
    if (parsedState.checkboxes && parsedState.checkboxes[key] !== undefined) {
      cb.checked = parsedState.checkboxes[key];
    }
  });

  // 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è
  const nameInput = document.getElementById('levelNameInput');
  if (nameInput && parsedState.name !== undefined) {
    nameInput.value = parsedState.name;
  }

  // 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è
  const descriptionInput = document.getElementById('levelDescription');
  if (descriptionInput && parsedState.description !== undefined) {
    descriptionInput.value = parsedState.description;
  }

  // 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ—è
  if (parsedState.currentLayer !== undefined) {
    currentLayer = parsedState.currentLayer;
    const buttons = document.querySelectorAll('.layer-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeButton = [...buttons].find(btn => parseInt(btn.dataset.layer) === currentLayer);
    if (activeButton) {
      activeButton.classList.add('active');
    }
  } else {
    currentLayer = 1;
  }

  // 7. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
  if (parsedState.fieldImageIndices) {
    drawGameFields(parsedState.fieldImageIndices);
    Object.entries(parsedState.fieldImageIndices).forEach(([key, index]) => {
      localStorage.setItem(`fieldImageIndex_${key}`, index);
    });
  }

  // 8. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  if (parsedState.editorMode) {
    editorModeSwitcher.value = parsedState.editorMode;
    puzzlePanel.style.display = parsedState.editorMode === 'puzzle' ? 'block' : 'none';
  }

  // 9. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫ –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫
  if (parsedState.puzzleIcons) {
    selectedPuzzleIcons = [...parsedState.puzzleIcons];
  } else {
    selectedPuzzleIcons = ['', '', '', '', ''];
  }

  // 10. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ —Ç–æ–∫–µ–Ω–æ–≤
  const savedRotations = localStorage.getItem('tokenRotations');
  if (savedRotations) {
    try {
      const rotations = JSON.parse(savedRotations);
      Object.entries(rotations).forEach(([key, value]) => {
        localStorage.setItem(key, value); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç—ã –ø–æ —Ç–æ—á–Ω–æ–º—É –∫–ª—é—á—É
      });
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤:", e);
    }
  }

  // 11. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ –±–æ–Ω—É—Å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
  const useBonusTokensCheckbox = document.getElementById('useBonusTokensCheckbox');
  if (useBonusTokensCheckbox) {
    const savedUseBonus = localStorage.getItem('useBonusTokens') === 'true';
    useBonusTokensCheckbox.checked = savedUseBonus;
    toggleBonusTokenVisibility();
  }

  // 12. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —è—á–µ–µ–∫
  document.querySelectorAll('.grid-cell').forEach(cell => {
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
	  // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ—ë–≤
	  for (let layer = 1; layer <= 3; layer++) {
		updateCell(cell, row, col, layer);
	  }
  });

  // 13. –§–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏
  validateLimits();
  updateTokenCounters();
  updateTokenStyles();
  updatePuzzleIconsDisplay();
}

//–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤ PNG
document.getElementById('saveButton').addEventListener('click', () => {

  const container = document.querySelector('.main-grid-container');
  if (!container) {
    alert("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.");
    return;
  }

  const levelNameInput = document.getElementById('levelNameInput');
  let levelName = levelNameInput?.value.trim();
  const fileName = levelName ? transliterate(levelName) + '.png' : 'bg_level.png';

    // === –°–ö–†–´–í–ê–ï–ú –¶–í–ï–¢–ù–´–ï –§–û–ù–´ –°–õ–û–Å–í ===
  const bgLayers = container.querySelectorAll('.token-wrapper > div[class^="token-bg-layer"]');
  const originalDisplay = [];
  bgLayers.forEach(el => el.remove());


  // === –°–ö–†–´–í–ê–ï–ú –ì–†–ê–ù–ò–¶–´ –Ø–ß–ï–ï–ö –î–õ–Ø –ß–ò–°–¢–û–ì–û –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
  const elementsToHideBorders = container.querySelectorAll('.grid-cell, #layer0 > div');
  const originalStyles = [];
  elementsToHideBorders.forEach(el => {
    originalStyles.push({ el, border: el.style.border });
    el.style.border = 'none';
  });

  function restoreStyles() {
    originalStyles.forEach(({ el, border }) => {
      el.style.border = border;
    });

    // === –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¶–í–ï–¢–ù–´–• –ö–í–ê–î–†–ê–¢–û–í ===
    bgLayers.forEach((el, i) => {
      el.style.display = originalDisplay[i].display; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    });
  }

  const ImgScale = 2; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

  // === –†–ï–ù–î–ï–†–ò–ú –ö–û–ù–¢–ï–ô–ù–ï–† –í canvas ===
  html2canvas(container, {
    backgroundColor: null, // <<< –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
    scale: window.devicePixelRatio * ImgScale // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –≤ 2 —Ä–∞–∑–∞
  }).then(canvas => {
    // === –ù–ê–•–û–î–ò–ú –ú–ò–ù/–ú–ê–ö–° –ì–†–ê–ù–ò–¶–´ –°–ï–¢–ö–ò (–±–µ–∑ –±–µ–ª—ã—Ö –∫—Ä–∞–µ–≤) ===
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
    const step = 5;

    for (let y = 0; y < canvas.height; y += step) {
      for (let x = 0; x < canvas.width; x += step) {
        const index = (y * canvas.width + x) * 4;
        const r = data[index];
        const g = data[index + 1];
        const b = data[index + 2];
        const a = data[index + 3];

        if (a === 0) continue;

        const isWhite = (
          r > 250 && g > 250 && b > 250
        );

        if (!isWhite) {
          minX = Math.min(minX, x);
          minY = Math.min(minY, y);
          maxX = Math.max(maxX, x);
          maxY = Math.max(maxY, y);
        }
      }
    }

    if (minX > maxX || minY > maxY) {
      alert("–ù–µ—Ç –≤–∏–¥–∏–º–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.");
      return Promise.reject("–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ");
    }

    const padding = 10;
    minX = Math.max(0, minX - padding);
    minY = Math.max(0, minY - padding);
    maxX = Math.min(canvas.width, maxX + padding);
    maxY = Math.min(canvas.height, maxY + padding);

    const width = maxX - minX;
    const height = maxY - minY;

    // === –û–ë–†–ï–ó–ê–ï–ú –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –°–ï–¢–ö–ò ===
    const croppedCanvas = document.createElement('canvas');
    croppedCanvas.width = width;
    croppedCanvas.height = height;

    const croppedCtx = croppedCanvas.getContext('2d');
    croppedCtx.fillStyle = "rgba(0, 0, 0, 0)";
    croppedCtx.fillRect(0, 0, width, height);

    croppedCtx.drawImage(
      canvas,
      minX, minY, width, height,
      0, 0, width, height
    );

    return croppedCanvas;
  }).then(croppedCanvas => {
    let icons = [];
    const puzzlePanel = document.getElementById('puzzleIconsContainer');
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: –µ—Å–ª–∏ —ç—Ç–æ "level", —Ç–æ –Ω–µ –≤–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª—å –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫
    const editorMode = editorModeSwitcher.value;
    if (editorMode === 'puzzle') {
      const iconElements = puzzlePanel?.querySelectorAll('img.puzzle-icon') || [];
      icons = Array.from(iconElements);
    } else {
      icons = [];
    }


    if (!icons.length && editorMode !== 'puzzle') {
      // –ï—Å–ª–∏ —Ä–µ–∂–∏–º level –∏ –Ω–µ—Ç –∏–∫–æ–Ω–æ–∫, –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
      downloadImage(croppedCanvas, fileName);
      return;
    }

    // –†–∞–∑–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –∏–∫–æ–Ω–æ–∫ –ø–∞–Ω–µ–ª–∏ –ì–æ–ª–æ–≤–æ–ª–æ–º–æ–∫, —Ä–∞–∑–º–µ—Ä –∑–∞–∑–æ—Ä–∞ –∏ —Ä–∞–∑–º–µ—Ä –ø–∞–Ω–µ–ª–∏ –æ–±—â–∏–π.
    const iconSize = 50 * ImgScale;
    const gap = 15 * ImgScale;
    const panelHeight = 50 * ImgScale;
    const totalWidth = icons.length * iconSize + (icons.length - 1) * gap;

    const iconCanvas = document.createElement('canvas');
    iconCanvas.width = totalWidth;
    iconCanvas.height = panelHeight;
    const iconCtx = iconCanvas.getContext('2d');

    const loadPromises = icons.map((icon, i) => {
      return new Promise(resolve => {
        const imgElement = icon;

        if (!imgElement || !imgElement.src || imgElement.src.includes('empty.png')) {
          resolve();
          return;
        }

        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = imgElement.src;

        img.onload = () => {
          iconCtx.drawImage(img, i * (iconSize + gap), 0, iconSize, iconSize);
          resolve();
        };

        img.onerror = (e) => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∫–æ–Ω–∫–∏:", imgElement.src, e);
          resolve();
        };
      });
    });

    if (editorMode === 'puzzle' && icons.length > 0) {
      Promise.all(loadPromises).then(() => {
        combineCanvases(iconCanvas, croppedCanvas, fileName);
      });
    } else {
      // –í —Ä–µ–∂–∏–º–µ —É—Ä–æ–≤–Ω—è –∏–ª–∏ –±–µ–∑ –∏–∫–æ–Ω–æ–∫ ‚Äî —Å—Ä–∞–∑—É —Å–∫–∞—á–∏–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
      downloadImage(croppedCanvas, fileName);
    }

  }).catch(err => {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", err);
    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
  }).finally(() => {
    restoreStyles(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –≥—Ä–∞–Ω–∏—Ü
  });

  // === –§–£–ù–ö–¶–ò–ò ===

  function combineCanvases(iconCanvas, gridCanvas, filename) {
    const padding = 20;

    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = Math.max(iconCanvas.width, gridCanvas.width);
    finalCanvas.height = iconCanvas.height + gridCanvas.height + padding;

    const finalCtx = finalCanvas.getContext('2d');

    // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
    finalCtx.fillStyle = "rgba(0, 0, 0, 0)";
    finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    const startX = (finalCanvas.width - iconCanvas.width) / 2;
    finalCtx.drawImage(iconCanvas, startX, 0); // <<< –ü–∞–Ω–µ–ª—å –≥–æ–ª–æ–≤–æ–ª–æ–º–æ–∫ —Å–≤–µ—Ä—Ö—É

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–∏–∂–µ
    finalCtx.drawImage(gridCanvas, 0, iconCanvas.height + padding); // <<< –ü–æ–ª–µ –Ω–∏–∂–µ –ø–∞–Ω–µ–ª–∏

    // === –í–†–ï–ú–ï–ù–ù–û–ï –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ===
    const outputDiv = document.getElementById('output');
    if (!outputDiv) {
      console.warn("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #output –Ω–µ –Ω–∞–π–¥–µ–Ω");
      downloadImage(finalCanvas, filename);
      return;
    }

    outputDiv.innerHTML = ''; // –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ

    const previewImg = document.createElement('img');
    previewImg.src = finalCanvas.toDataURL('image/png');
    previewImg.style.maxWidth = '100%';
    previewImg.style.border = '1px solid #ccc';
    previewImg.style.marginBottom = '10px';

    const infoText = document.createElement('div');
    infoText.textContent = '–ü–æ–¥–æ–∂–¥–∏—Ç–µ... –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã.';
    infoText.style.marginBottom = '10px';

    outputDiv.appendChild(previewImg);
    outputDiv.appendChild(infoText);

    // === –°–ö–ê–ß–ò–í–ê–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ß–ï–†–ï–ó 3 –°–ï–ö–£–ù–î–´ ===
//    setTimeout(() => {
      const link = document.createElement('a');
      link.download = filename;
      link.href = finalCanvas.toDataURL('image/png');
      document.body.appendChild(link); // Firefox fix
      link.click();
      document.body.removeChild(link);

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      outputDiv.innerHTML = '';
//    }, 3000);
  }

  function downloadImage(canvas, filename) {
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
});

// –û—á–∏—Å—Ç–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
document.getElementById('clearButton').addEventListener('click', () => {
  if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –í–µ—Ä–Ω—É—Ç—å —É—Ä–æ–≤–µ–Ω—å –Ω–∞–∑–∞–¥ –±—É–¥–µ—Ç –Ω–µ–ª—å–∑—è!")) {

    localStorage.clear();

    // === –û—á–∏—Å—Ç–∫–∞ —Å–µ—Ç–∫–∏ ===
    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        grid[row][col] = ['', '', ''];
        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (cell) cell.innerHTML = '';
      }
    }

    // === –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ–ª–µ–π ===
    Object.keys(userFieldPositions).forEach(key => delete userFieldPositions[key]);

    // === –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–µ 4x4 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ===
    const default4x4 = { row: 0, col: 3 };
    userFieldPositions["4x4"] = default4x4;
    
    // === –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ===
    const nameInput = document.getElementById('levelNameInput');
    const descriptionInput = document.getElementById('levelDescription');
    if (nameInput) nameInput.value = ''; // –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
    if (descriptionInput) descriptionInput.value = ''; // –û—á–∏—Å—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è

    // === –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã ===
    document.querySelectorAll('[data-field]').forEach(cb => {
      cb.checked = cb.dataset.field === "4x4"; // –¢–æ–ª—å–∫–æ 4x4 –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∫–ª—é—á—ë–Ω–Ω—ã–º
      cb.disabled = false; // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã
    });

    // === –°–ë–†–û–° –ò–ù–î–ï–ö–°–û–í –ö–ê–†–¢–ò–ù–û–ö –ü–û–õ–ï–ô ===
    document.querySelectorAll('.grid-field').forEach(img => {
      img.src = fieldImages[img.dataset.fieldKey][0]; // —Å—Ç–∞–≤–∏–º –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
      img.dataset.imageIndex = 0;
      localStorage.removeItem(`fieldImageIndex_${img.dataset.fieldKey}`); // —É–¥–∞–ª—è–µ–º –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    });

    // === –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–ª—è ===
    const fieldImageIndices = {};
    document.querySelectorAll('.grid-field').forEach(img => {
      fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
    });
    drawGameFields(fieldImageIndices);

    // === –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —è—á–µ–µ–∫ ===
    document.querySelectorAll('.grid-cell').forEach(cell => {
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);
      updateCell(cell, row, col);
    });

    // === –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ –∏ —Å—Ç–∏–ª–µ–π ===
    validateLimits();
    updateTokenCounters();
    updateTokenStyles();

    currentLayer = 1;
    const buttons = document.querySelectorAll('.layer-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    buttons[1].classList.add('active'); // –°–ª–æ–π 1

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    saveStateToLocalStorage();
  }
});


function updateFieldCheckboxes() {
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–∞—Ä—É –æ—Ç–¥–µ–ª—å–Ω–æ
  const pairs = [
    ['2x4_1', '4x2_1'],
    ['2x4_2', '4x2_2']
  ];

  pairs.forEach(([oldKey, newKey]) => {
    const oldField = document.querySelector(`input[data-field="${oldKey}"]`);
    const newField = document.querySelector(`input[data-field="${newKey}"]`);

    if (!oldField || !newField) return;

    if (newField.checked) {
      oldField.checked = false;
      oldField.disabled = true;
    } else if (!newField.checked && !document.querySelector(`input[data-field="${newKey === '4x2_1' ? '4x2_2' : '4x2_1'}"]`).checked) {
      oldField.disabled = false;
    }
  });
}

document.querySelectorAll('.new-field').forEach(cb => {
  cb.addEventListener('change', () => {
    updateFieldCheckboxes();
    
    const fieldImageIndices = {};
    document.querySelectorAll('.grid-field').forEach(img => {
      fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
    });
    drawGameFields(fieldImageIndices);

  });
});


// –ü–∞—Ä—ã –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏—Ö –ø–æ–ª–µ–π
const mutuallyExclusivePairs = [
  ['2x4_1', '4x2_1'],
  ['2x4_2', '4x2_2']
];

function updateMutualExclusion() {
  // –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
  document.querySelectorAll('[data-field]').forEach(cb => {
    cb.disabled = false;
  });

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–∞—Ä—É –æ—Ç–¥–µ–ª—å–Ω–æ
  mutuallyExclusivePairs.forEach(([key1, key2]) => {
    const cb1 = document.querySelector(`input[data-field="${key1}"]`);
    const cb2 = document.querySelector(`input[data-field="${key2}"]`);

    if (!cb1 || !cb2) return;

    if (cb1.checked) {
      cb2.checked = false;
      cb2.disabled = true;
    } else if (cb2.checked) {
      cb1.checked = false;
      cb1.disabled = true;
    }
  });
}

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–æ–±—ã—Ç–∏—è–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
document.querySelectorAll('[data-field]').forEach(cb => {
  cb.addEventListener('change', () => {
    updateMutualExclusion();
    
    const fieldImageIndices = {};
    document.querySelectorAll('.grid-field').forEach(img => {
      fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
    });
    drawGameFields(fieldImageIndices);

  });
});

// –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
updateMutualExclusion();

// === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤ JSON —Å –ø–æ–≤–æ—Ä–æ—Ç–∞–º–∏ ===
document.getElementById('saveLevelButton').addEventListener('click', () => {
  const levelNameInput = document.getElementById('levelNameInput');
  let levelName = levelNameInput.value.trim();
  if (!levelName) {
    alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è!");
    return;
  }
  const latinName = transliterate(levelName);

  // === –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ ===
  const mapEditorState = localStorage.getItem('mapEditorState');
  if (!mapEditorState) {
    alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è.");
    return;
  }

  try {
    const loaded = JSON.parse(mapEditorState);

    // === –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è —É—Ä–æ–≤–Ω—è ===
    loaded.name = levelName;

    // === –ü–æ–ª—É—á–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç—ã –∏–∑ localStorage ===
    const tokenRotations = localStorage.getItem('tokenRotations');
    if (tokenRotations) {
      try {
        loaded.rotations = JSON.parse(tokenRotations);
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ rotations:", e);
        loaded.rotations = {};
      }
    } else {
      loaded.rotations = {}; // –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
    }

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª JSON ===
    const blob = new Blob([JSON.stringify(loaded, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${latinName}.json`;
    link.click();

    // === (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –ø–æ–¥ –∏–º–µ–Ω–µ–º ===
    localStorage.setItem(`savedLevel_${latinName}`, JSON.stringify(loaded));

    alert(`–§–∞–π–ª —É—Ä–æ–≤–Ω—è "${levelName}.json" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.`);
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ —É—Ä–æ–≤–Ω—è –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é:", e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å ‚Äî –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.");
  }
});


//–ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–≤–Ω—è –∏–∑ JSON
document.getElementById('loadLevelButton').addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const loaded = JSON.parse(text);

      // === –®–ê–ì 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ grid –∏ –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
      for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
          grid[r][c] = ['', '', ''];
        }
      }

      for (let r = 0; r < loaded.grid.length; r++) {
        for (let c = 0; c < loaded.grid[r].length; c++) {
          if (loaded.grid[r][c]) {
            grid[r][c] = [...loaded.grid[r][c]];
          }
        }
      }

      // –û—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ userFieldPositions
      Object.keys(userFieldPositions).forEach(key => delete userFieldPositions[key]);
      if (loaded.userFieldPositions) {
        Object.assign(userFieldPositions, loaded.userFieldPositions);
      }

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
      document.querySelectorAll('[data-field]').forEach(cb => {
        const key = cb.dataset.field;
        cb.checked = loaded.checkboxes?.[key] ?? false;
      });

		// === –®–ê–ì: –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è" –∏ "–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è" ===
		const nameInput = document.getElementById('levelNameInput');
		const descriptionInput = document.getElementById('levelDescription');

		if (nameInput) {
		  nameInput.value = loaded.name || '';
		}

		if (descriptionInput) {
		  descriptionInput.value = loaded.description || '';
		}

      // === –®–ê–ì 2: –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç—ã –∫ —Ç–æ–∫–µ–Ω–∞–º —á–µ—Ä–µ–∑ localStorage –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é ===
      if (loaded.rotations && typeof loaded.rotations === 'object') {
        Object.entries(loaded.rotations).forEach(([key, value]) => {
          localStorage.setItem(key, value);
        });
        
        Object.keys(loaded.rotations).forEach(key => {
		});
      }

      const fieldImageIndices = loaded.fieldImageIndices || {};
      drawGameFields(fieldImageIndices);

      // === –®–ê–ì 3: –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫–∏ —Å —É—á–µ—Ç–æ–º –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ ===
      document.querySelectorAll('.grid-cell').forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        updateCell(cell, row, col);
      });

      validateLimits();
      updateTokenCounters();
      updateTokenStyles();

      // === –®–ê–ì 4: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –≤ localStorage –∑–∞ –æ–¥–∏–Ω –≤—ã–∑–æ–≤ ===
      saveStateToLocalStorage();

      alert(`–£—Ä–æ–≤–µ–Ω—å "${loaded.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.`);

    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON:", e);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–≤–Ω—è ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.");
    }
  };
  input.click();
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–∞–∂–¥—ã–µ 7 –¥–Ω–µ–π
function shouldRefreshCache(timestampKey, maxAgeMs = 7 * 24 * 60 * 60 * 1000) {
  const lastCached = localStorage.getItem(timestampKey);
  return !lastCached || Date.now() - parseInt(lastCached) > maxAgeMs;
}

function cacheImageWithExpiry(url) {
  const timestampKey = `cached_image_timestamp_${url}`;
  const cachedUrlKey = `cached_image_${url}`;

  // –ï—Å–ª–∏ –∫—ç—à –∞–∫—Ç—É–∞–ª–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
  if (!shouldRefreshCache(timestampKey)) {
    const cached = localStorage.getItem(cachedUrlKey);
    if (cached) {
      return Promise.resolve(cached);
    }
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  return fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.blob();
    })
    .then(blob => {
      const reader = new FileReader();
      return new Promise((resolve, reject) => {
        reader.onload = () => {
          localStorage.setItem(cachedUrlKey, reader.result);
          localStorage.setItem(timestampKey, Date.now());
          resolve(reader.result);
        };
        reader.onerror = () => reject(new Error('FileReader error'));
        reader.readAsDataURL(blob);
      });
    })
    .catch(err => {
      console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ "${url}"`, err);

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const fallback = localStorage.getItem(cachedUrlKey);
      if (fallback) {
        console.log("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫—ç—à –≤–º–µ—Å—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
        return fallback;
      }

      // –ò–Ω–∞—á–µ ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π URL
      return url;
    });
}

// –ö–æ–¥ –¥–ª—è –∑–æ–Ω—ã –∫–æ—Ä–∑–∏–Ω—ã
const trashZone = document.getElementById('trashZone');

if (trashZone) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ dragover (–¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ drop)
  trashZone.addEventListener('dragover', e => {
    e.preventDefault();
    trashZone.style.backgroundColor = '#ffebee';
  });

  trashZone.addEventListener('dragleave', () => {
    trashZone.style.backgroundColor = '';
  });

  trashZone.addEventListener('drop', e => {
    e.preventDefault();
    trashZone.style.backgroundColor = '';
    const tokenName = e.dataTransfer.getData('text/plain');
    const fromRow = parseInt(e.dataTransfer.getData('from-row'));
    const fromCol = parseInt(e.dataTransfer.getData('from-col'));

    if (!isNaN(fromRow) && !isNaN(fromCol)) {
      grid[fromRow][fromCol][currentLayer - 1] = '';
      const cell = document.querySelector(`[data-row="${fromRow}"][data-col="${fromCol}"]`);
      if (cell) {
        updateCell(cell, fromRow, fromCol);
      }
      validateLimits();
      updateTokenCounters();
      updateTokenStyles();
      saveStateToLocalStorage();
    }
  });
}

// === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–µ—Ç–æ–Ω—ã –∫—Ä–∞—É–¥—Ñ–∞–Ω–¥–∏–Ω–≥–∞" –∏ —Ñ—É–Ω–∫—Ü–∏—è –∏—Ö —Å–æ–∫—Ä—ã—Ç–∏—è
document.getElementById('useBonusTokensCheckbox').addEventListener('change', function () {
  const show = this.checked;

  // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –ø–∞–Ω–µ–ª–∏
  document.querySelectorAll('.token-pair-wrapper').forEach(wrapper => {
    const isBonusPair = wrapper.querySelector('[data-pair-group="bonus-pair"]');
    const isArucoPair = wrapper.querySelector('[data-pair-group="aruco-pair"]');
    if (isBonusPair || isArucoPair) {
      wrapper.style.display = show ? 'inline-block' : 'none';
    }
  });

  // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã –Ω–∞ –∏–≥—Ä–æ–≤–æ–º –ø–æ–ª–µ
  document.querySelectorAll('.token').forEach(img => {
    const tokenName = img.alt;
    const token = tokens.find(t => t.name === tokenName);
    if (token && (token.pairGroup === 'bonus-pair' || token.pairGroup === 'aruco-pair')) {
      img.style.visibility = show ? 'visible' : 'hidden';
    }
  });

  saveStateToLocalStorage();
});


// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–Ω—É—Å-–∂–µ—Ç–æ–Ω–æ–≤
function toggleBonusTokenVisibility() {
  const checkbox = document.getElementById('useBonusTokensCheckbox');
  const show = checkbox?.checked;
  document.querySelectorAll('.token-pair-wrapper').forEach(wrapper => {
    const isBonusPair = wrapper.querySelector('[data-pair-group="bonus-pair"]');
    const isArucoPair = wrapper.querySelector('[data-pair-group="aruco-pair"]');
    if (isBonusPair || isArucoPair) {
      wrapper.style.display = show ? 'inline-block' : 'none';
    }
  });
  document.querySelectorAll('.token').forEach(img => {
    const tokenName = img.alt;
    const token = tokens.find(t => t.name === tokenName);
    if (token && (token.pairGroup === 'bonus-pair' || token.pairGroup === 'aruco-pair')) {
      img.style.visibility = show ? 'visible' : 'hidden';
    }
  });
}


// –ë–ª–æ–∫ –∏–∫–æ–Ω–æ–∫ –∫ –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞–º
const puzzleIconsContainer = document.getElementById('puzzleIconsContainer');

let selectedPuzzleIcons = ['', '', '', '', '']; // –¥–æ 5 –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

  function updatePuzzleIconsDisplay() {
    const icons = document.querySelectorAll('.puzzle-icon');
    icons.forEach((icon, index) => {
      const key = selectedPuzzleIcons[index];
      if (key) {
        const condition = puzzleConditions.find(c => c.key === key);
        if (condition) {
          icon.src = getCachedImageURL(condition.image);
          icon.alt = condition.key;
        }
      } else {
        icon.src = getCachedImageURL(IMAGE_PREFIX + 'empty.png');
        icon.alt = '';
      }
    });
  }

function createPuzzleIcons() {
  puzzleIconsContainer.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.textAlign = 'center';

    const icon = document.createElement('img');
    icon.src = IMAGE_PREFIX + 'empty.png'; // –ø—É—Ç—å –∫ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏–ª–∏ —Ñ–æ–Ω—É
    icon.alt = 'empty';
    icon.className = 'puzzle-icon';
    icon.dataset.index = i;

    icon.addEventListener('click', () => {
      cyclePuzzleIcon(icon);
    });

    const label = document.createElement('div');
    label.textContent = `#${i+1}`;
    label.style.fontSize = '10px';
    label.style.marginTop = '4px';

    wrapper.appendChild(icon);
    wrapper.appendChild(label);
    puzzleIconsContainer.appendChild(wrapper);
  }
}

  const puzzleSlots = {
    0: ['lvl1', 'lvl2', 'lvl3', 'lvl4', 'lvl5'], // #1: —É—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    1: ['repeat2', 'condition', 'attack', 'defense', 'bot1', 'bot2'], // #2: –±–æ–Ω—É—Å—ã –∏ –±–æ—Ç—ã
    2: ['repeat2', 'condition', 'attack', 'defense', 'bot1', 'bot2'], // #3: –±–æ–Ω—É—Å—ã –∏ –±–æ—Ç—ã
    3: ['repeat2', 'condition', 'attack', 'defense', 'bot1', 'bot2'], // #4: –±–æ–Ω—É—Å—ã –∏ –±–æ—Ç—ã
    4: ['line1', 'line2', 'line3', 'line4', 'line5', 'line6', 'lineN'] // #5: –ª–∏–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
  };

  function cyclePuzzleIcon(icon) {
    const index = parseInt(icon.dataset.index);
    const currentKey = selectedPuzzleIcons[index];

    // –ü–æ–ª—É—á–∞–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞
    const allowedKeys = puzzleSlots[index] || [];

    // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–ª—é—á
    const currentIndex = allowedKeys.indexOf(currentKey);
    const nextIndex = (currentIndex + 1) % (allowedKeys.length + 1); // +1 –¥–ª—è empty

    if (nextIndex === allowedKeys.length) {
      // empty
      icon.src = IMAGE_PREFIX + 'empty.png';
      icon.alt = '';
      icon.classList.remove('active');
      selectedPuzzleIcons[index] = '';
    } else {
      const condition = puzzleConditions.find(c => c.key === allowedKeys[nextIndex]);
      if (condition) {
        icon.src = getCachedImageURL(condition.image);
        icon.alt = condition.key;
        icon.classList.add('active');
        selectedPuzzleIcons[index] = condition.key;
      }
    }

    saveStateToLocalStorage();
  }

  const editorModeSwitcher = document.getElementById('editorModeSwitcher');
  const puzzlePanel = document.getElementById('puzzlePanelIcons');

  editorModeSwitcher.addEventListener('change', () => {
    const mode = editorModeSwitcher.value;
    if (mode === 'puzzle') {
      puzzlePanel.style.display = 'block';
    } else {
      puzzlePanel.style.display = 'none';
    }
    saveStateToLocalStorage();
  });

  // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ===
  function loadEditorMode() {
    const savedState = localStorage.getItem('mapEditorState');
    if (savedState) {
      try {
        const parsedState = JSON.parse(savedState);
        if (parsedState.editorMode) {
          editorModeSwitcher.value = parsedState.editorMode;
          if (parsedState.editorMode === 'puzzle') {
            puzzlePanel.style.display = 'block';
          }
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∂–∏–º–∞:", e);
      }
    }
  }

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –ø–æ–ª–µ–π —Å —É—á–µ—Ç–æ–º –∏—Ö —Å—Ç–æ—Ä–æ–Ω—ã

  function rebuildBackgroundFields(fieldImageIndices) {
    const layer0 = document.getElementById('layer0');
    layer0.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ–ª—è

    document.querySelectorAll('[data-field]').forEach(cb => {
      const key = cb.dataset.field;
      if (cb.checked) {
        const pos = userFieldPositions[key] || fieldPositions[key] || { row: 0, col: 0 };
        let rowsSpan, colsSpan;

        if (key === '4x4') {
          rowsSpan = colsSpan = 4;
        } else if (key.startsWith('2x4')) {
          rowsSpan = 4;
          colsSpan = 2;
        } else if (key.startsWith('4x2')) {
          rowsSpan = 2;
          colsSpan = 4;
        }

        const images = fieldImages[key];
        const index = fieldImageIndices?.[key] ?? 0;
        const imgUrl = images[index];

        const cachedUrl = getCachedImageURL(imgUrl);

        const img = createField(cachedUrl, key, pos.row, pos.col, rowsSpan, colsSpan);
        img.dataset.imageIndex = index;
        layer0.appendChild(img);
      }
    });

    if (currentLayer === 0) {
      makeDraggable([...layer0.children]);
    }
  }


// –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –ø—Ä–∏ F5
// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===

loadStateFromLocalStorage(); // <-- –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
toggleBonusTokenVisibility();
createPuzzleIcons();
updatePuzzleIconsDisplay();

    const fieldImageIndices = {};
    document.querySelectorAll('.grid-field').forEach(img => {
      fieldImageIndices[img.dataset.fieldKey] = parseInt(img.dataset.imageIndex || '0');
    });
    drawGameFields(fieldImageIndices);

document.querySelectorAll('.grid-cell').forEach(cell => {
  const row = parseInt(cell.dataset.row);
  const col = parseInt(cell.dataset.col);
  updateCell(cell, row, col);
});

validateLimits();
updateTokenCounters();
updateTokenStyles();
toggleBonusTokenVisibility();
loadEditorMode();

</script>
</body>
</html>
